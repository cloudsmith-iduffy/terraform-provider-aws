name: Test Registry Publishing

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create fake artifacts
        run: |
          mkdir -p dist
          echo "fake binary" > dist/terraform-provider-aws_6.31.1_linux_amd64.zip
          cp terraform-registry-manifest.json dist/terraform-provider-aws_6.31.1_manifest.json
          cd dist
          shasum -a 256 *.zip *.json > terraform-provider-aws_6.31.1_SHA256SUMS

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Export GPG public key
        id: gpg_pub
        run: |
          PUB_KEY=$(gpg --armor --export "${{ steps.import_gpg.outputs.fingerprint }}")
          echo "ascii_armor<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PUB_KEY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Sign checksums
        run: |
          cd dist
          gpg --batch --local-user "${{ steps.import_gpg.outputs.fingerprint }}" \
            --output terraform-provider-aws_6.31.1_SHA256SUMS.sig \
            --detach-sign terraform-provider-aws_6.31.1_SHA256SUMS

      - name: Debug - Show files and env
        run: |
          ls -la dist/
          echo "TOKEN length: ${#TOKEN}"
          echo "BRANCH: $BRANCH"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages

      - name: Publish to GitHub Pages Registry (Manual)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_KEYID: ${{ steps.import_gpg.outputs.keyid }}
        run: |
          set -x
          
          # Clone or create gh-pages branch
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/cloudsmith-iduffy/terraform-provider-aws.git"
          
          echo "Attempting to clone gh-pages branch..."
          if git clone --depth=1 --branch=gh-pages "$REPO_URL" registry-repo; then
            echo "Successfully cloned existing gh-pages"
            cd registry-repo
          else
            echo "gh-pages doesn't exist or clone failed, creating fresh..."
            mkdir -p registry-repo
            cd registry-repo
            git init
            git remote add origin "$REPO_URL"
            git checkout -b gh-pages
            mkdir -p terraform/providers/v1
          fi
          
          # Generate provider metadata
          PROVIDER_NAME="terraform-provider-aws"
          VERSION="6.31.1"
          NAMESPACE="cloudsmith-iduffy"
          
          # Create versions.json
          cat > terraform/providers/v1/${NAMESPACE}/aws/versions <<EOF
          {
            "versions": [
              {
                "version": "${VERSION}",
                "protocols": ["5.0"],
                "platforms": [
                  {"os": "linux", "arch": "amd64"},
                  {"os": "linux", "arch": "arm64"},
                  {"os": "darwin", "arch": "arm64"}
                ]
              }
            ]
          }
          EOF
          
          # Create download.json for each platform
          mkdir -p terraform/providers/v1/${NAMESPACE}/aws/${VERSION}/download
          
          for platform in "linux_amd64" "linux_arm64" "darwin_arm64"; do
            cat > terraform/providers/v1/${NAMESPACE}/aws/${VERSION}/download/${platform}/index.json <<EOF
          {
            "protocols": ["5.0"],
            "os": "${platform%_*}",
            "arch": "${platform#*_}",
            "filename": "${PROVIDER_NAME}_${VERSION}_${platform}.zip",
            "download_url": "https://github.com/${NAMESPACE}/terraform-provider-aws/releases/download/v${VERSION}/${PROVIDER_NAME}_${VERSION}_${platform}.zip",
            "shasums_url": "https://github.com/${NAMESPACE}/terraform-provider-aws/releases/download/v${VERSION}/${PROVIDER_NAME}_${VERSION}_SHA256SUMS",
            "shasums_signature_url": "https://github.com/${NAMESPACE}/terraform-provider-aws/releases/download/v${VERSION}/${PROVIDER_NAME}_${VERSION}_SHA256SUMS.sig",
            "shasum": "$(cd ../dist && shasum -a 256 ${PROVIDER_NAME}_${VERSION}_${platform}.zip | awk '{print $1}')",
            "signing_keys": {
              "gpg_public_keys": [
                {
                  "key_id": "${GPG_KEYID}",
                  "ascii_armor": "${{ steps.gpg_pub.outputs.ascii_armor }}"
                }
              ]
            }
          }
          EOF
          done
          
          git add .
          git commit -m "Update registry for v${VERSION}" || echo "No changes to commit"
          git push origin gh-pages
